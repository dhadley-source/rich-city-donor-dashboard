<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RICH CITY Rides Donor Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
        }
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #dc2626;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header matching your website -->
    <header class="bg-black text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-8 py-4 flex items-center justify-between">
            <div class="flex items-center gap-6">
                <!-- Upload your logo.png to GitHub and it will display here -->
                <img src="logo.png" alt="RICH CITY Rides" class="h-20 w-20" onerror="this.style.display='none'; document.getElementById('logo-fallback').style.display='block';">
                <div id="logo-fallback" style="display: none;" class="text-center">
                    <div class="text-xl font-black border-2 border-white px-2 py-0.5">RICH</div>
                    <div class="text-xl font-black border-2 border-white px-2 py-0.5 -mt-0.5">CITY</div>
                </div>
                <div>
                    <h1 class="text-2xl font-bold">Donor Dashboard</h1>
                    <p class="text-sm text-gray-400">Internal Use Only</p>
                </div>
            </div>
            <div>
                <a href="https://richcityrides.org" target="_blank" class="text-sm hover:text-gray-300 flex items-center gap-2">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                    Back to Website
                </a>
            </div>
        </div>
    </header>

    <div class="min-h-screen">
        <div class="max-w-7xl mx-auto px-8 py-8">
            <!-- Stats Overview -->
            <div id="total-stats" class="mb-8 bg-white rounded-lg shadow-lg p-6 border-l-4 border-red-600">
                <p class="text-gray-900 font-semibold text-lg">Loading data...</p>
            </div>

            <div id="loading" class="loading">
                <div class="spinner"></div>
            </div>

            <div id="dashboard-content" style="display: none;">
                <div id="campaigns-container"></div>

                <div class="bg-white border-l-4 border-gray-400 p-4 rounded-lg shadow mb-4">
                    <p class="text-gray-700 text-sm">
                        <strong>üìù To update:</strong> Edit the Google Sheet and refresh this page. Data updates automatically!
                    </p>
                    <p class="text-gray-700 text-sm mt-2">
                        <strong>‚ûï New campaign:</strong> Just add donors with a new campaign name in the Google Sheet.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSMCAPlabXC3X5O_PSpTcFmuTX-ok5dTViW8pg3aOoqsIr2KLfnIDTZJF7oJNdL8sg2jtc34-1T7wN6/pub?output=csv';

        let allCampaigns = {};
        let selectedDonors = {};

        async function loadDataFromSheet() {
            try {
                const response = await fetch(SHEET_URL);
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        const allDonors = results.data.map(d => ({
                            name: d.Name || '',
                            email: d.Email || '',
                            address: d.Address || '',
                            city: d.City || '',
                            state: d.State || '',
                            zip: d.Zip || '',
                            country: d.Country || '',
                            amount: parseFloat(d.Amount) || 0,
                            date: d.Date || '',
                            paymentType: d['Payment Type'] || '',
                            message: d.Message || '',
                            campaign: d.Campaign || '',
                            campaignStartDate: d['Campaign Start Date'] || '',
                            campaignEndDate: d['Campaign End Date'] || '',
                            taxReceiptSent: d['Tax Receipt Sent'] || 'No',
                            thankYouSent: d['Thank You Sent'] || 'No'
                        })).filter(d => d.name && d.campaign);

                        allCampaigns = {};
                        allDonors.forEach(donor => {
                            if (!allCampaigns[donor.campaign]) {
                                allCampaigns[donor.campaign] = {
                                    donors: [],
                                    startDate: donor.campaignStartDate,
                                    endDate: donor.campaignEndDate
                                };
                            }
                            allCampaigns[donor.campaign].donors.push(donor);
                        });

                        renderDashboard();
                    }
                });
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="text-center p-8">
                        <p class="text-red-600 font-semibold mb-2">‚ö†Ô∏è Error loading data</p>
                        <p class="text-gray-600 text-sm">Make sure your Google Sheet is published to the web as CSV.</p>
                        <p class="text-gray-500 text-xs mt-2">Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        function renderDashboard() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard-content').style.display = 'block';

            let grandTotal = 0;
            let totalDonors = 0;
            Object.values(allCampaigns).forEach(campaign => {
                campaign.donors.forEach(d => grandTotal += d.amount);
                totalDonors += campaign.donors.length;
            });

            document.getElementById('total-stats').innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-gray-900 font-black text-4xl">$${grandTotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                        <p class="text-gray-600 mt-2">${totalDonors} donors across ${Object.keys(allCampaigns).length} campaigns</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-500">Last Updated</p>
                        <p class="text-lg font-semibold">${new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' })}</p>
                    </div>
                </div>
            `;

            const container = document.getElementById('campaigns-container');
            container.innerHTML = '';
            
            // Sort campaigns by start date (most recent first)
            const sortedCampaigns = Object.keys(allCampaigns).sort((a, b) => {
                const dateA = allCampaigns[a].startDate;
                const dateB = allCampaigns[b].startDate;
                
                // If no dates, sort alphabetically
                if (!dateA && !dateB) return a.localeCompare(b);
                if (!dateA) return 1;
                if (!dateB) return -1;
                
                // Parse dates and sort (most recent first)
                const parsedA = new Date(dateA);
                const parsedB = new Date(dateB);
                return parsedB - parsedA;
            });
            
            // Red shades for campaigns while staying on brand
            const headerColors = [
                'bg-gradient-to-r from-gray-900 to-black',
                'bg-gradient-to-r from-red-900 to-black',
                'bg-gradient-to-r from-gray-800 to-gray-900',
                'bg-gradient-to-r from-red-800 to-gray-900',
                'bg-gradient-to-r from-black to-red-900'
            ];
            
            const borderColors = [
                'border-red-600',
                'border-red-700',
                'border-gray-700',
                'border-red-500',
                'border-gray-600'
            ];
            
            let colorIndex = 0;
            sortedCampaigns.forEach(campaignName => {
                const campaign = allCampaigns[campaignName];
                const donors = campaign.donors;
                const startDate = campaign.startDate;
                const endDate = campaign.endDate;
                const campaignId = campaignName.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
                const headerColor = headerColors[colorIndex % headerColors.length];
                const borderColor = borderColors[colorIndex % borderColors.length];
                colorIndex++;
                
                // Calculate campaign duration
                let durationText = '';
                let dateRangeText = '';
                if (startDate && endDate) {
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    const diffTime = Math.abs(end - start);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    // Format duration intelligently
                    if (diffDays === 1) {
                        durationText = '1 Day';
                    } else if (diffDays < 7) {
                        durationText = `${diffDays} Days`;
                    } else if (diffDays < 30) {
                        const weeks = Math.floor(diffDays / 7);
                        const remainingDays = diffDays % 7;
                        durationText = weeks === 1 ? '1 Week' : `${weeks} Weeks`;
                        if (remainingDays > 0) durationText += ` ${remainingDays}d`;
                    } else {
                        const months = Math.floor(diffDays / 30);
                        const remainingDays = diffDays % 30;
                        durationText = months === 1 ? '1 Month' : `${months} Months`;
                        if (remainingDays > 0 && months < 3) durationText += ` ${remainingDays}d`;
                    }
                    
                    dateRangeText = `${start.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} - ${end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                } else if (startDate) {
                    const start = new Date(startDate);
                    dateRangeText = start.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                    durationText = 'Ongoing';
                }
                
                const campaignHtml = `
                    <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-8 border-t-4 ${borderColor}">
                        <div class="${headerColor} p-6 text-white">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h2 class="text-2xl font-black uppercase tracking-wide">${campaignName}</h2>
                                    <div class="mt-3 flex items-center gap-6">
                                        ${dateRangeText ? `<div class="text-gray-300 text-sm"><span class="font-semibold">üìÖ</span> ${dateRangeText}</div>` : ''}
                                        ${durationText ? `<div class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm font-bold"><span class="opacity-75">‚è±</span> ${durationText}</div>` : ''}
                                    </div>
                                </div>
                                <button onclick="exportCSV('${campaignId}')" class="flex items-center gap-2 bg-red-600 text-white px-4 py-3 rounded hover:bg-red-700 transition font-bold uppercase text-sm tracking-wide shadow-lg">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    Export
                                </button>
                            </div>
                            
                            <div id="${campaignId}-stats" class="grid grid-cols-3 gap-4 mt-6">
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-100 border-b-2 border-gray-300">
                                    <tr>
                                        <th class="text-left p-4 font-bold text-gray-700 text-xs uppercase tracking-wider">Name</th>
                                        <th class="text-left p-4 font-bold text-gray-700 text-xs uppercase tracking-wider">Email</th>
                                        <th class="text-left p-4 font-bold text-gray-700 text-xs uppercase tracking-wider">Location</th>
                                        <th class="text-right p-4 font-bold text-gray-700 text-xs uppercase tracking-wider">Amount</th>
                                        <th class="text-left p-4 font-bold text-gray-700 text-xs uppercase tracking-wider">Date</th>
                                        <th class="text-center p-4 font-bold text-gray-700 text-xs uppercase tracking-wider">Tax Receipt</th>
                                        <th class="text-center p-4 font-bold text-gray-700 text-xs uppercase tracking-wider">Thank You</th>
                                    </tr>
                                </thead>
                                <tbody id="${campaignId}-table">
                                </tbody>
                            </table>
                        </div>

                        <div id="${campaignId}-details" class="hidden p-6 bg-gray-50 border-t-2 border-gray-200">
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', campaignHtml);
                
                renderCampaignStats(donors, `${campaignId}-stats`);
                renderTable(donors, `${campaignId}-table`, `${campaignId}-details`, campaignId);
            });
        }

        function renderCampaignStats(donors, statsId) {
            const total = donors.reduce((sum, d) => sum + d.amount, 0);
            const avg = donors.length > 0 ? Math.round(total / donors.length) : 0;
            
            document.getElementById(statsId).innerHTML = `
                <div class="bg-white bg-opacity-10 p-4 rounded backdrop-blur">
                    <p class="text-sm font-semibold text-gray-300 uppercase tracking-wide">Total Donors</p>
                    <p class="text-3xl font-black mt-1">${donors.length}</p>
                </div>
                <div class="bg-white bg-opacity-10 p-4 rounded backdrop-blur">
                    <p class="text-sm font-semibold text-gray-300 uppercase tracking-wide">Total Raised</p>
                    <p class="text-3xl font-black mt-1">$${total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                </div>
                <div class="bg-white bg-opacity-10 p-4 rounded backdrop-blur">
                    <p class="text-sm font-semibold text-gray-300 uppercase tracking-wide">Average Gift</p>
                    <p class="text-3xl font-black mt-1">$${avg}</p>
                </div>
            `;
        }

        function renderTable(donors, tableId, detailsId, campaignId) {
            const tbody = document.getElementById(tableId);
            tbody.innerHTML = '';
            
            donors.forEach((donor, idx) => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50 cursor-pointer transition';
                row.onclick = () => toggleDetails(idx, donors, detailsId, campaignId);
                
                const taxReceiptIcon = donor.taxReceiptSent.toLowerCase() === 'yes' 
                    ? '<span class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold">‚úì SENT</span>' 
                    : '<span class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-bold">PENDING</span>';
                
                const thankYouIcon = donor.thankYouSent.toLowerCase() === 'yes' 
                    ? '<span class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold">‚úì SENT</span>' 
                    : '<span class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-bold">PENDING</span>';
                
                row.innerHTML = `
                    <td class="p-4 font-bold text-gray-900">${donor.name}</td>
                    <td class="p-4 text-gray-600 text-sm">${donor.email}</td>
                    <td class="p-4 text-gray-600 text-sm">${donor.city && donor.state ? `${donor.city}, ${donor.state}` : 'N/A'}</td>
                    <td class="p-4 text-right font-black text-gray-900 text-lg">$${donor.amount.toFixed(2)}</td>
                    <td class="p-4 text-gray-600 text-sm">${donor.date}</td>
                    <td class="p-4 text-center">${taxReceiptIcon}</td>
                    <td class="p-4 text-center">${thankYouIcon}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function toggleDetails(idx, donors, detailsId, campaignId) {
            const detailsDiv = document.getElementById(detailsId);
            const currentSelection = selectedDonors[campaignId];
            
            if (currentSelection === idx) {
                detailsDiv.classList.add('hidden');
                selectedDonors[campaignId] = null;
                return;
            }
            
            selectedDonors[campaignId] = idx;
            
            const donor = donors[idx];
            detailsDiv.classList.remove('hidden');
            detailsDiv.innerHTML = `
                <h3 class="text-lg font-black text-gray-900 mb-4 pb-2 border-b-2 border-gray-300 uppercase tracking-wide">Donor Details</h3>
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <p class="text-xs text-gray-500 uppercase font-bold mb-1 tracking-wider">Full Name</p>
                        <p class="font-bold text-gray-900">${donor.name}</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 uppercase font-bold mb-1 tracking-wider">Email</p>
                        <p class="font-semibold text-gray-900">${donor.email}</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 uppercase font-bold mb-1 tracking-wider">Full Address</p>
                        <p class="font-semibold text-gray-900">
                            ${donor.address || 'N/A'}<br>
                            ${donor.city ? `${donor.city}, ${donor.state} ${donor.zip}` : ''}
                            ${donor.country ? `<br>${donor.country}` : ''}
                        </p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 uppercase font-bold mb-1 tracking-wider">Payment Method</p>
                        <p class="font-semibold text-gray-900">${donor.paymentType}</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 uppercase font-bold mb-1 tracking-wider">Tax Receipt Status</p>
                        <p class="font-bold ${donor.taxReceiptSent.toLowerCase() === 'yes' ? 'text-green-600' : 'text-red-600'}">
                            ${donor.taxReceiptSent.toLowerCase() === 'yes' ? '‚úì SENT' : 'PENDING'}
                        </p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 uppercase font-bold mb-1 tracking-wider">Thank You Status</p>
                        <p class="font-bold ${donor.thankYouSent.toLowerCase() === 'yes' ? 'text-green-600' : 'text-red-600'}">
                            ${donor.thankYouSent.toLowerCase() === 'yes' ? '‚úì SENT' : 'PENDING'}
                        </p>
                    </div>
                    ${donor.message ? `
                        <div class="col-span-2 bg-gray-100 p-4 rounded">
                            <p class="text-xs text-gray-500 uppercase font-bold mb-2 tracking-wider">Donor Message</p>
                            <p class="font-semibold text-gray-900 italic">"${donor.message}"</p>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function exportCSV(campaignId) {
            const campaignName = Object.keys(allCampaigns).find(name => 
                name.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase() === campaignId
            );
            const donors = allCampaigns[campaignName].donors;
            
            const headers = ["Name", "Email", "Address", "City", "State", "Zip", "Country", "Amount", "Date", "Payment Type", "Message", "Campaign", "Tax Receipt Sent", "Thank You Sent"];
            const rows = donors.map(d => [
                d.name,
                d.email,
                d.address,
                d.city,
                d.state,
                d.zip,
                d.country,
                d.amount,
                d.date,
                d.paymentType,
                d.message,
                d.campaign,
                d.taxReceiptSent,
                d.thankYouSent
            ]);
            
            const csvContent = [headers, ...rows]
                .map(row => row.map(cell => `"${cell}"`).join(","))
                .join("\n");
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${campaignId}_donors.csv`;
            a.click();
        }

        loadDataFromSheet();
    </script>
</body>
</html>
