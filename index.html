<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RICH CITY Rides Donor Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
        }
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen p-8">
        <div class="max-w-7xl mx-auto">
            <div class="mb-8">
                <h1 class="text-4xl font-bold text-gray-900">RICH CITY Rides - Donor Database</h1>
                <p class="text-gray-600 mt-2">Live data from Google Sheets</p>
                <div id="total-stats" class="mt-4 bg-blue-50 border-l-4 border-blue-600 p-4 rounded">
                    <p class="text-blue-900 font-semibold">Loading data...</p>
                </div>
            </div>

            <div id="loading" class="loading">
                <div class="spinner"></div>
            </div>

            <div id="dashboard-content" style="display: none;">
                <!-- Campaign 1 -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-6 text-white">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold">Support RICH CITY Rides</h2>
                                <p class="mt-2 opacity-90">Campaign donations</p>
                            </div>
                            <button onclick="exportCSV('campaign1')" class="flex items-center gap-2 bg-white text-blue-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition font-semibold">
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                Export CSV
                            </button>
                        </div>
                        
                        <div id="campaign1-stats" class="grid grid-cols-3 gap-4 mt-6">
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-100 border-b">
                                <tr>
                                    <th class="text-left p-4 font-semibold text-gray-700">Name</th>
                                    <th class="text-left p-4 font-semibold text-gray-700">Email</th>
                                    <th class="text-left p-4 font-semibold text-gray-700">Location</th>
                                    <th class="text-right p-4 font-semibold text-gray-700">Amount</th>
                                    <th class="text-left p-4 font-semibold text-gray-700">Date</th>
                                    <th class="text-center p-4 font-semibold text-gray-700">Tax Receipt</th>
                                    <th class="text-center p-4 font-semibold text-gray-700">Thank You</th>
                                </tr>
                            </thead>
                            <tbody id="campaign1-table">
                            </tbody>
                        </table>
                    </div>

                    <div id="campaign1-details" class="hidden p-6 bg-gray-50 border-t">
                    </div>
                </div>

                <!-- Campaign 2 -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-6 text-white">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold">Help Rich City Rides Roll into the New Year!</h2>
                                <p class="mt-2 opacity-90">Campaign donations</p>
                            </div>
                            <button onclick="exportCSV('campaign2')" class="flex items-center gap-2 bg-white text-blue-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition font-semibold">
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                Export CSV
                            </button>
                        </div>
                        
                        <div id="campaign2-stats" class="grid grid-cols-3 gap-4 mt-6">
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-100 border-b">
                                <tr>
                                    <th class="text-left p-4 font-semibold text-gray-700">Name</th>
                                    <th class="text-left p-4 font-semibold text-gray-700">Email</th>
                                    <th class="text-left p-4 font-semibold text-gray-700">Location</th>
                                    <th class="text-right p-4 font-semibold text-gray-700">Amount</th>
                                    <th class="text-left p-4 font-semibold text-gray-700">Date</th>
                                    <th class="text-center p-4 font-semibold text-gray-700">Tax Receipt</th>
                                    <th class="text-center p-4 font-semibold text-gray-700">Thank You</th>
                                </tr>
                            </thead>
                            <tbody id="campaign2-table">
                            </tbody>
                        </table>
                    </div>

                    <div id="campaign2-details" class="hidden p-6 bg-gray-50 border-t">
                    </div>
                </div>

                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded mb-4">
                    <p class="text-yellow-800 text-sm">
                        <strong>üìù To update this dashboard:</strong> Edit the Google Sheet and refresh this page. Data updates automatically!
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSMCAPlabXC3X5O_PSpTcFmuTX-ok5dTViW8pg3aOoqsIr2KLfnIDTZJF7oJNdL8sg2jtc34-1T7wN6/pub?output=csv';

        let campaign1Donors = [];
        let campaign2Donors = [];
        let selectedCampaign1 = null;
        let selectedCampaign2 = null;

        async function loadDataFromSheet() {
            try {
                const response = await fetch(SHEET_URL);
                const csvText = await response.text();
                
                // Parse CSV using PapaParse
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        const allDonors = results.data.map(d => ({
                            name: d.Name || '',
                            email: d.Email || '',
                            address: d.Address || '',
                            city: d.City || '',
                            state: d.State || '',
                            zip: d.Zip || '',
                            country: d.Country || '',
                            amount: parseFloat(d.Amount) || 0,
                            date: d.Date || '',
                            paymentType: d['Payment Type'] || '',
                            message: d.Message || '',
                            campaign: d.Campaign || '',
                            taxReceiptSent: d['Tax Receipt Sent'] || 'No',
                            thankYouSent: d['Thank You Sent'] || 'No'
                        })).filter(d => d.name);

                        campaign1Donors = allDonors.filter(d => d.campaign === 'Support RICH CITY Rides');
                        campaign2Donors = allDonors.filter(d => d.campaign === 'Help Rich City Rides Roll into the New Year!');

                        renderDashboard();
                    }
                });
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="text-center p-8">
                        <p class="text-red-600 font-semibold mb-2">‚ö†Ô∏è Error loading data</p>
                        <p class="text-gray-600 text-sm">Make sure your Google Sheet is published to the web as CSV.</p>
                        <p class="text-gray-500 text-xs mt-2">Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        function renderDashboard() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard-content').style.display = 'block';

            const total1 = campaign1Donors.reduce((sum, d) => sum + d.amount, 0);
            const total2 = campaign2Donors.reduce((sum, d) => sum + d.amount, 0);
            const grandTotal = total1 + total2;
            const totalDonors = campaign1Donors.length + campaign2Donors.length;

            document.getElementById('total-stats').innerHTML = `
                <p class="text-blue-900 font-semibold">Total across both campaigns: $${grandTotal.toFixed(2)}</p>
                <p class="text-blue-800 text-sm mt-1">${totalDonors} donors ‚Ä¢ 2 campaigns</p>
            `;

            renderCampaignStats(campaign1Donors, 'campaign1-stats');
            renderCampaignStats(campaign2Donors, 'campaign2-stats');
            renderTable(campaign1Donors, 'campaign1-table', 'campaign1-details', 1);
            renderTable(campaign2Donors, 'campaign2-table', 'campaign2-details', 2);
        }

        function renderCampaignStats(donors, statsId) {
            const total = donors.reduce((sum, d) => sum + d.amount, 0);
            const avg = donors.length > 0 ? Math.round(total / donors.length) : 0;
            
            document.getElementById(statsId).innerHTML = `
                <div class="bg-white bg-opacity-20 p-4 rounded-lg backdrop-blur">
                    <p class="text-sm font-medium opacity-90">Total Donors</p>
                    <p class="text-3xl font-bold">${donors.length}</p>
                </div>
                <div class="bg-white bg-opacity-20 p-4 rounded-lg backdrop-blur">
                    <p class="text-sm font-medium opacity-90">Total Raised</p>
                    <p class="text-3xl font-bold">$${total.toFixed(2)}</p>
                </div>
                <div class="bg-white bg-opacity-20 p-4 rounded-lg backdrop-blur">
                    <p class="text-sm font-medium opacity-90">Average Gift</p>
                    <p class="text-3xl font-bold">$${avg}</p>
                </div>
            `;
        }

        function renderTable(donors, tableId, detailsId, campaignNum) {
            const tbody = document.getElementById(tableId);
            tbody.innerHTML = '';
            
            donors.forEach((donor, idx) => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50 cursor-pointer transition';
                row.onclick = () => toggleDetails(idx, donors, detailsId, campaignNum);
                
                const taxReceiptIcon = donor.taxReceiptSent.toLowerCase() === 'yes' 
                    ? '<span class="text-green-600 font-bold">‚úì</span>' 
                    : '<span class="text-red-500">‚úó</span>';
                
                const thankYouIcon = donor.thankYouSent.toLowerCase() === 'yes' 
                    ? '<span class="text-green-600 font-bold">‚úì</span>' 
                    : '<span class="text-red-500">‚úó</span>';
                
                row.innerHTML = `
                    <td class="p-4 font-medium text-gray-900">${donor.name}</td>
                    <td class="p-4 text-gray-600">${donor.email}</td>
                    <td class="p-4 text-gray-600">${donor.city && donor.state ? `${donor.city}, ${donor.state}` : 'N/A'}</td>
                    <td class="p-4 text-right font-semibold text-green-700">$${donor.amount.toFixed(2)}</td>
                    <td class="p-4 text-gray-600">${donor.date}</td>
                    <td class="p-4 text-center">${taxReceiptIcon}</td>
                    <td class="p-4 text-center">${thankYouIcon}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function toggleDetails(idx, donors, detailsId, campaignNum) {
            const detailsDiv = document.getElementById(detailsId);
            const currentSelection = campaignNum === 1 ? selectedCampaign1 : selectedCampaign2;
            
            if (currentSelection === idx) {
                detailsDiv.classList.add('hidden');
                if (campaignNum === 1) selectedCampaign1 = null;
                else selectedCampaign2 = null;
                return;
            }
            
            if (campaignNum === 1) selectedCampaign1 = idx;
            else selectedCampaign2 = idx;
            
            const donor = donors[idx];
            detailsDiv.classList.remove('hidden');
            detailsDiv.innerHTML = `
                <h3 class="text-lg font-bold text-gray-900 mb-4">Donor Details</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-600">Full Name</p>
                        <p class="font-semibold text-gray-900">${donor.name}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Email</p>
                        <p class="font-semibold text-gray-900">${donor.email}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Full Address</p>
                        <p class="font-semibold text-gray-900">
                            ${donor.address || 'N/A'}<br>
                            ${donor.city ? `${donor.city}, ${donor.state} ${donor.zip}` : ''}
                            ${donor.country ? `<br>${donor.country}` : ''}
                        </p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Payment Method</p>
                        <p class="font-semibold text-gray-900">${donor.paymentType}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Tax Receipt Status</p>
                        <p class="font-semibold ${donor.taxReceiptSent.toLowerCase() === 'yes' ? 'text-green-600' : 'text-red-600'}">
                            ${donor.taxReceiptSent.toLowerCase() === 'yes' ? '‚úì Sent' : '‚úó Not Sent'}
                        </p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Thank You Note Status</p>
                        <p class="font-semibold ${donor.thankYouSent.toLowerCase() === 'yes' ? 'text-green-600' : 'text-red-600'}">
                            ${donor.thankYouSent.toLowerCase() === 'yes' ? '‚úì Sent' : '‚úó Not Sent'}
                        </p>
                    </div>
                    ${donor.message ? `
                        <div class="col-span-2">
                            <p class="text-sm text-gray-600">Donor Message</p>
                            <p class="font-semibold text-gray-900 italic">"${donor.message}"</p>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function exportCSV(campaign) {
            const donors = campaign === 'campaign1' ? campaign1Donors : campaign2Donors;
            const campaignName = campaign === 'campaign1' ? 'support_rich_city_rides' : 'help_rich_city_rides_roll_into_new_year';
            
            const headers = ["Name", "Email", "Address", "City", "State", "Zip", "Country", "Amount", "Date", "Payment Type", "Message", "Campaign", "Tax Receipt Sent", "Thank You Sent"];
            const rows = donors.map(d => [
                d.name,
                d.email,
                d.address,
                d.city,
                d.state,
                d.zip,
                d.country,
                d.amount,
                d.date,
                d.paymentType,
                d.message,
                d.campaign,
                d.taxReceiptSent,
                d.thankYouSent
            ]);
            
            const csvContent = [headers, ...rows]
                .map(row => row.map(cell => `"${cell}"`).join(","))
                .join("\n");
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${campaignName}_donors.csv`;
            a.click();
        }

        loadDataFromSheet();
    </script>
</body>
</html>
